#############################################################################
# OpenWrt syslog-ng.conf specific file
# which collects all local logs into a single file called /var/log/messages.
# More details about these settings can be found here:
# https://www.syslog-ng.com/technical-documents/list/syslog-ng-open-source-edition

@version: 4.4
@include "scl.conf"

options {
	time-zone("America/New_York");
	chain_hostnames(no); # Enable or disable the chained hostname format.
	create_dirs(yes);
	keep_hostname(yes); # Enable or disable hostname rewriting.
	log_fifo_size(10000); # The number of messages that the output queue can store.
	log_msg_size(65536); # Maximum length of a message in bytes.
	stats_freq(3600); # The period between two STATS messages (sent by syslog-ng, containing statistics about dropped logs) in seconds.
	flush_lines(1); # How many lines are flushed to a destination at a time.
	use_fqdn(no); # Add Fully Qualified Domain Name instead of short hostname.
};

# syslog-ng gets messages from syslog-ng (internal) and from /dev/log

source s_src {
	internal();
	unix-dgram("/dev/log" keep-timestamp(no) time-zone("America/New_York"));
};

source s_kernel {
        file("/proc/kmsg" program_override("kernel") keep-timestamp(no) time-zone("America/New_York"));
};

destination d_auth {
	file("/var/log/auth.log");
};

destination d_cron {
    	file("/var/log/cron.log");
};

destination d_daemon {
    	file("/var/log/daemon.log");
};

destination d_kern {
    	file("/var/log/kern.log");
};

destination d_local {
	file("/var/log/local.log");
};

destination d_syslog {
	file("/var/log/syslog");
};

destination d_syslog-ng {
	file("/var/log/syslog-ng.log");
};

destination d_user {
	file("/var/log/user.log");
};

destination d_debug {
	file("/var/log/debug");
};

destination d_error {
	file("/var/log/error.log");
};

destination d_messages {
	file("/var/log/messages");
};

destination d_firewall {
	file("/var/log/firewall.log");
};

destination d_banip {
	file("/var/log/banip.log");
};

destination d_vpn {
	file("/var/log/vpn-policy-routing.log");
};

destination d_alert {
	file("/var/log/alert.log");
};

destination d_security {
	file("/var/log/security.log");
};

destination d_mwan3 {
	file("/var/log/mwan3.log");
};

filter f_dbg {
	level(debug);
};

filter f_info {
	level(info);
};

filter f_notice {
	level(notice);
};

filter f_err {
	level(err);
};

filter f_warn {
	level(warn);
};

filter f_crit {
	level(crit..emerg);
};

filter f_debug {
	level(debug) and not facility(auth, authpriv, news, mail) and not filter(f_banip) and not filter(f_firewall);
};

filter f_error {
	level(err..emerg) and not filter(f_cron);
};

filter f_messages {
	level(info, notice, warn) and not facility(auth, authpriv, cron, daemon, mail, news) and not filter(f_banip) and not filter(f_firewall) and not filter(f_vpn) and not filter(f_syslog-ng) and not filter(f_mwan3);
};

filter f_auth {
	facility(auth, authpriv);
};

filter f_cron {
	facility(cron);
};

filter f_daemon {
	facility(daemon);
};

filter f_kern {
	facility(kern) and not filter(f_firewall) and not filter(f_banip) and not filter(f_mwan3);
};

filter f_local {
	facility(local0..local7);
};

filter f_syslog3 {
	not facility(auth, authpriv, mail) and not filter(f_firewall) and not filter(f_banip) and not filter(f_vpn) and not filter(f_daemon) and not filter(f_mwan3);
};

filter f_mwan3_log {
    match("mwan3" value("PROGRAM"));
};

filter f_mwan3_traffic {
	match("MWAN3" value("MESSAGE"));
};

filter f_mwan3 {
	filter(f_mwan3_log) or filter(f_mwan3_traffic);
};

filter f_syslog-ng {
	facility(syslog);
};

filter f_user {
	facility(user) and not filter(f_debug) and not filter(f_vpn) and not filter(f_mwan3);
};

filter f_firewall {
	match("REJECT wan in:" value("MESSAGE")) or match("drop wan invalid ct state:" value("MESSAGE"));
};

filter f_banipmessage {
	match("banIP" value("MESSAGE"));
};

filter f_progbanip {
	match("banIP" value("PROGRAM"));
};

filter f_banip {
	filter(f_progbanip) or filter(f_banipmessage);
};

filter f_vpn {
	match("vpn-policy-routing" value("PROGRAM"));
};

filter f_security {
	facility(security);
};

filter f_alert {
	facility(console);
};

#log {
	#source(s_src);
	#source();
        #source(s_kernel);
	#destination(d_messages);

	# uncomment this line to open port 514 to receive messages
	#source(s_network);
#};

log {
	source(s_src);
	source(s_kernel);
	filter(f_mwan3);
	destination(d_mwan3);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_auth);
	destination(d_auth);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_cron);
	destination(d_cron);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_daemon);
	destination(d_daemon);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_kern);
	destination(d_kern);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_local);
	destination(d_local);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_syslog3);
	destination(d_syslog);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_syslog-ng);
	destination(d_syslog-ng);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_user);
	destination(d_user);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_debug);
	destination(d_debug);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_error);
	destination(d_error);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_messages);
	destination(d_messages);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_firewall);
	destination(d_firewall);
};

#log {
#	source(s_src);
#	source(s_kernel);
#	filter(f_banip);
#	destination(d_banip);
#};

#log {
#	source(s_src);
#	source(s_kernel);
#	filter(f_vpn);
#	destination(d_vpn);
#};

log {
	source(s_src);
	source(s_kernel);
	filter(f_security);
	destination(d_security);
};

log {
	source(s_src);
	source(s_kernel);
	filter(f_alert);
	destination(d_alert);
};

#log {
#	source(s_src);
#	source(s_kernel);
#	source(s_net);
#	destination(d_ctkpi);
#};

#
# Finally, include any user settings last so that s/he can override or
# supplement all "canned" settings inherited from the distribution.
#
@include "/etc/syslog-ng.d/" # Put any customization files in this directory
